name: SonarCloud Scan
description: >
  Scan your code with SonarCloud to detect bugs, vulnerabilities and code smells
  in 26+ programming languages.
branding:
  icon: check
  color: green
runs:
  using: composite
  steps:
    - name: Restore sonarcloud Image Cache if it exists
      id: cache-docker-sonarcloud
      uses: actions/cache@v3
      with:
        path: ci/cache/docker/sonarcloud
        key: cache-docker-sonarcloud

    - name: Update sonarcloud Image Cache if cache miss
      if: steps.cache-docker-sonarcloud.outputs.cache-hit != 'true'
      shell: bash
      run: docker pull sonar-cloud:scanner-cli-5.0 && mkdir -p ci/cache/docker/sonarcloud && docker image save sonar-cloud:scanner-cli-5.0 --output ./ci/cache/docker/sonarcloud/scanner-cli-5.0.tar

    - name: Use sonarcloud Image Cache if cache hit
      if: steps.cache-docker-sonarcloud.outputs.cache-hit == 'true'
      shell: bash
      run: docker image load --input ./ci/cache/docker/sonarcloud/scanner-cli-5.0.tar

    - name: Build docker image
      shell: bash
      run: |
        docker build \
        --tag sonarcloud:latest \
        --file Dockerfile

    - name: Run sonarcloud scanner
      shell: bash
      run: |
        docker run --rm sonarcloud:latest /entrypoint.sh

inputs:
  args:
    description: Additional arguments to the sonarcloud scanner
    required: false
  projectBaseDir:
    description: Set the sonar.projectBaseDir analysis property
    required: false
    default: .
